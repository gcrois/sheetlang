name: Deploy

on:
    push:
        branches: ["**"]
    workflow_dispatch:

permissions:
    contents: read
    deployments: write

concurrency:
    group: "pages-${{ github.ref_name }}"
    cancel-in-progress: true

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            # ─── pnpm cache ───────────────────────────────────────────────────────────
            - name: Cache pnpm store
              uses: actions/cache@v4
              with:
                  path: ~/.pnpm-store
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('web/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-

            # ─── Cargo cache (registry + git index + build artefacts) ────────────────
            - name: Cache cargo
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-

            # ─── Toolchains ──────────────────────────────────────────────────────────
            - uses: actions-rs/toolchain@v1
              with:
                  toolchain: nightly

            - uses: actions/setup-node@v4
              with:
                  node-version: "22"

            - uses: pnpm/action-setup@v3
              with:
                  version: 10

            # ─── Install wasm-pack ──────────────────────────────────────────────
            - name: Install cargo-binstall
              run: curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash

            - name: Install wasm-pack
              run: cargo binstall -y wasm-pack

            # ─── Build WASM module ───────────────────────────────────────────────
            - name: Build WASM module
              run: wasm-pack build --target web --out-dir web/pkg

            # ─── Build web ──────────────────────────────────────────────────────
            - name: Install deps
              working-directory: ./web
              run: pnpm install --no-frozen-lockfile

            - name: Build
              working-directory: ./web
              run: pnpm build
              env:
                  VITE_PAGES_HOST: ${{ vars.VITE_PAGES_HOST }}

            - name: Derive Pages branch slug
              id: pages_branch
              run: |
                  set -euo pipefail
                  raw_branch="${GITHUB_REF_NAME}"
                  slug="$(printf "%s" "${raw_branch}" | tr '[:upper:]' '[:lower:]' | sed -E 's#[^a-z0-9-]+#-#g; s#-+#-#g; s#^-+|-+$##g')"
                  if [ -z "${slug}" ]; then
                    echo "Slug resolved to empty. Branch: ${raw_branch}" >&2
                    exit 1
                  fi
                  echo "slug=${slug}" >> "${GITHUB_OUTPUT}"

            - name: Deploy to Cloudflare Pages
              uses: cloudflare/wrangler-action@v3
              with:
                apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                command: >
                    pages deploy ${{ vars.CLOUDFLARE_OUTPUT_DIR }}
                    --project-name ${{ vars.CLOUDFLARE_PROJECT_NAME }}
                    --branch ${{ steps.pages_branch.outputs.slug }}
